# syntax=docker/dockerfile:1
################################################################################
# Reachy Mini Simulation + Pipecat Bot Container
# - All features from original sim container
# - Pipecat WebRTC bot with ElevenLabs STT/TTS
# - NeMo Agent Toolkit for multimodal routing
# - Uses uv for 10-100x faster Python package installation
################################################################################

FROM nvidia/cuda:12.4.1-runtime-ubuntu22.04

LABEL org.opencontainers.image.source="https://github.com/liveaverage/brev-launch-reachymini-sim"
LABEL org.opencontainers.image.description="Reachy Mini simulation with Pipecat WebRTC bot"
LABEL org.opencontainers.image.licenses="Apache-2.0"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Python and display configuration
ENV PYTHON_VERSION=3.12
ENV PYTHONUNBUFFERED=1
ENV DISPLAY=:1
ENV VGL_DISPLAY=egl
ENV RESOLUTION=1024x768

# Application ports
ENV NOVNC_PORT=6080
ENV DASHBOARD_PORT=8000
ENV JUPYTER_PORT=8888
# Pipecat WebRTC ports (replaces conversation app)
ENV PIPECAT_PORT=7880
ENV NAT_PORT=8001

# WebRTC UDP port range for media
ENV RTC_PORT_RANGE_MIN=10000
ENV RTC_PORT_RANGE_MAX=20000

# Reachy Mini configuration
ENV REACHY_SCENE=empty

# API Keys (set at runtime)
ENV NVIDIA_API_KEY=""
ENV ELEVENLABS_API_KEY=""

# ============================================================================
# System Dependencies
# ============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core utilities
    ca-certificates \
    curl \
    wget \
    git \
    gnupg2 \
    software-properties-common \
    # Build essentials for Python packages
    build-essential \
    pkg-config \
    cmake \
    # X11 and virtual framebuffer
    xvfb \
    x11-utils \
    x11-xserver-utils \
    xauth \
    dbus-x11 \
    # Window manager (lightweight)
    openbox \
    # VNC server for Xvfb
    x11vnc \
    # Mesa for EGL/OpenGL
    libgl1-mesa-glx \
    libgl1-mesa-dri \
    libegl1-mesa \
    libgles2-mesa \
    libglvnd0 \
    libglvnd-dev \
    # Audio (for Pipecat TTS/STT)
    pulseaudio \
    libportaudio2 \
    portaudio19-dev \
    libsndfile1 \
    ffmpeg \
    # Network utilities
    net-tools \
    procps \
    # Required for aiortc (WebRTC)
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswresample-dev \
    libopus-dev \
    libvpx-dev \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Python 3.12 via deadsnakes PPA
# ============================================================================
RUN add-apt-repository ppa:deadsnakes/ppa -y \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        python${PYTHON_VERSION} \
        python${PYTHON_VERSION}-venv \
        python${PYTHON_VERSION}-dev \
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.12 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${PYTHON_VERSION} 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python${PYTHON_VERSION} 1

# ============================================================================
# uv - Ultra-fast Python package installer (10-100x faster than pip)
# ============================================================================
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

# Verify uv installation and install pip for compatibility
RUN uv --version && uv pip install --system pip

# ============================================================================
# VirtualGL (GPU-accelerated OpenGL) - Optional
# ============================================================================
ARG VIRTUALGL_VERSION=3.1.1
RUN curl -fsSL -o /tmp/virtualgl.deb \
    "https://github.com/VirtualGL/virtualgl/releases/download/${VIRTUALGL_VERSION}/virtualgl_${VIRTUALGL_VERSION}_amd64.deb" \
    && apt-get update \
    && dpkg -i /tmp/virtualgl.deb || (apt-get install -fy && dpkg -i /tmp/virtualgl.deb) \
    && rm /tmp/virtualgl.deb \
    && rm -rf /var/lib/apt/lists/* \
    || echo "VirtualGL installation failed - continuing without it"

ENV PATH="/opt/VirtualGL/bin:${PATH}"

# ============================================================================
# noVNC (web-based VNC client)
# ============================================================================
ARG NOVNC_VERSION=1.4.0
ARG WEBSOCKIFY_VERSION=0.11.0

RUN mkdir -p /opt/noVNC \
    && curl -fsSL "https://github.com/novnc/noVNC/archive/refs/tags/v${NOVNC_VERSION}.tar.gz" \
        | tar -xz -C /opt/noVNC --strip-components=1 \
    && ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

# ============================================================================
# Caddy (reverse proxy with TLS for WebRTC signaling)
# ============================================================================
RUN curl -fsSL "https://caddyserver.com/api/download?os=linux&arch=amd64" -o /usr/local/bin/caddy \
    && chmod +x /usr/local/bin/caddy

# ============================================================================
# Python Dependencies - All installed via uv for speed
# Single layer to maximize cache efficiency
# ============================================================================
RUN uv pip install --system \
    # Supervisor (process manager)
    supervisor \
    # Websockify for noVNC
    websockify==${WEBSOCKIFY_VERSION} \
    # Reachy Mini SDK with MuJoCo + Dances
    "reachy-mini[mujoco]>=1.2.4" \
    "reachy-mini-dances-library>=0.2.1" \
    # Jupyter and data science
    jupyterlab \
    ipywidgets \
    matplotlib \
    opencv-python-headless \
    numpy \
    Pillow \
    # Pipecat AI Framework with WebRTC transport
    "pipecat-ai[daily,local-smart-turn-v3]>=0.0.98" \
    "pipecat-ai-small-webrtc-prebuilt>=2.0.0" \
    "aiortc>=1.14.0" \
    "onnxruntime>=1.23.2" \
    "transformers>=4.57.3" \
    python-dotenv \
    aiohttp \
    loguru \
    # NeMo Agent Toolkit
    "nvidia-nat[langchain]>=1.3.1"

# ============================================================================
# Configuration Files
# ============================================================================

# Create directories
RUN mkdir -p /etc/supervisor/conf.d /var/log/supervisor /etc/caddy

# Supervisor configuration
COPY config/supervisord-pipecat.conf /etc/supervisor/conf.d/supervisord.conf

# Caddy configuration for TLS (WebRTC requires HTTPS)
COPY config/Caddyfile.pipecat /etc/caddy/Caddyfile

# Generate self-signed certificate
RUN openssl req -x509 -newkey rsa:2048 -nodes \
    -keyout /etc/caddy/key.pem -out /etc/caddy/cert.pem \
    -days 999 -subj '/CN=reachy-mini' \
    && chmod 644 /etc/caddy/cert.pem /etc/caddy/key.pem

# Entrypoint and helper scripts
COPY scripts/entrypoint-pipecat.sh /entrypoint.sh
COPY scripts/patch-websocket.sh /patch-websocket.sh
RUN chmod +x /entrypoint.sh /patch-websocket.sh

# Openbox configuration
RUN mkdir -p /root/.config/openbox
COPY config/openbox-rc.xml /root/.config/openbox/rc.xml

# Jupyter configuration
RUN mkdir -p /root/.jupyter
COPY config/jupyter_config.py /root/.jupyter/jupyter_lab_config.py

# ============================================================================
# Pipecat Bot Application
# ============================================================================
RUN mkdir -p /app/bot /app/nat

# Copy bot application
COPY bot/ /app/bot/
COPY nat/ /app/nat/

# Install NAT custom components
WORKDIR /app/nat
RUN uv pip install --system -e .

# Create workspace for user notebooks/code
RUN mkdir -p /workspace
WORKDIR /workspace

# Clone example notebooks
RUN git clone --depth 1 https://github.com/pollen-robotics/reachy_mini.git /opt/reachy_mini_repo \
    && cp -r /opt/reachy_mini_repo/examples /workspace/examples \
    && rm -rf /opt/reachy_mini_repo

# ============================================================================
# Ports
# ============================================================================
# TCP: 6080 (noVNC), 7880 (Pipecat WebRTC signaling), 8000 (Dashboard), 
#      8001 (NAT), 8888 (Jupyter)
# UDP: 10000-20000 (WebRTC RTP/RTCP media)
EXPOSE 6080 7880 8000 8001 8888
EXPOSE 10000-20000/udp

# ============================================================================
# Entrypoint
# ============================================================================
ENTRYPOINT ["/entrypoint.sh"]
