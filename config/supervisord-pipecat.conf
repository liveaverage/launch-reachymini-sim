[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info

# =============================================================================
# Xvfb - Virtual Framebuffer (Headless)
# Uses display :99 (standard for headless) to avoid conflicts with host :0/:1
# Enhanced: +iglx for indirect GLX, faster rendering
# Note: Smart lock cleanup by entrypoint.sh (only removes stale locks)
# =============================================================================
[program:xvfb]
command=/bin/bash -c "exec Xvfb :99 -screen 0 %(ENV_RESOLUTION)sx24 +extension GLX +render -noreset -ac +iglx"
autostart=true
autorestart=true
priority=10
startsecs=2
stdout_logfile=/var/log/supervisor/xvfb.log
stderr_logfile=/var/log/supervisor/xvfb_err.log

# =============================================================================
# Openbox - Lightweight Window Manager
# =============================================================================
[program:openbox]
command=/bin/bash -c "sleep 3 && DISPLAY=:99 openbox"
autostart=true
autorestart=true
priority=20
startsecs=5
stdout_logfile=/var/log/supervisor/openbox.log
stderr_logfile=/var/log/supervisor/openbox_err.log

# =============================================================================
# x11vnc - VNC Server for Xvfb display
# No password - accessed via secure tunnel
# =============================================================================
[program:x11vnc]
command=/bin/bash -c "sleep 4 && x11vnc -display :99 -forever -shared -rfbport 5901 -nopw -xkb -threads -noxrecord -noxfixes -noxdamage -repeat -cursor arrow -ncache 10 -ncache_cr -speeds lan"
autostart=true
autorestart=true
priority=30
startsecs=6
stdout_logfile=/var/log/supervisor/x11vnc.log
stderr_logfile=/var/log/supervisor/x11vnc_err.log

# =============================================================================
# noVNC - Web-based VNC client via websockify
# =============================================================================
[program:novnc]
command=/bin/bash -c "sleep 6 && websockify --web=/opt/noVNC %(ENV_NOVNC_PORT)s localhost:5901"
autostart=true
autorestart=true
priority=40
startsecs=8
stdout_logfile=/var/log/supervisor/novnc.log
stderr_logfile=/var/log/supervisor/novnc_err.log

# =============================================================================
# Reachy Mini Daemon - MuJoCo Simulation
# Runs with --no-localhost-only so Pipecat bot can connect
# =============================================================================
[program:reachy-daemon]
command=/bin/bash -c "sleep 10 && python -m reachy_mini.daemon.app.main --sim --scene %(ENV_REACHY_SCENE)s --no-localhost-only"
environment=DISPLAY=":99",MUJOCO_GL="egl",__GLX_VENDOR_LIBRARY_NAME="nvidia",__NV_PRIME_RENDER_OFFLOAD="1",MUJOCO_EGL_DEVICE_ID="0",MESA_GL_VERSION_OVERRIDE="4.5",__EGL_VENDOR_LIBRARY_FILENAMES="/usr/share/glvnd/egl_vendor.d/10_nvidia.json"
autostart=true
autorestart=true
priority=50
startsecs=12
stopwaitsecs=10
stdout_logfile=/var/log/supervisor/reachy-daemon.log
stderr_logfile=/var/log/supervisor/reachy-daemon_err.log

# =============================================================================
# NeMo Agent Toolkit Server
# Provides AI routing between Nemotron models (text, VLM, agent)
# =============================================================================
[program:nat-server]
command=/bin/bash -c "sleep 15 && cd /app/nat && nat serve --config_file src/ces_tutorial/config.yml --port %(ENV_NAT_PORT)s"
environment=PYTHONUNBUFFERED="1"
autostart=true
autorestart=true
priority=55
startsecs=18
stopwaitsecs=10
stdout_logfile=/var/log/supervisor/nat-server.log
stderr_logfile=/var/log/supervisor/nat-server_err.log

# =============================================================================
# Pipecat Bot - WebRTC Voice/Vision AI
# Connects to NAT for LLM routing, ElevenLabs for STT/TTS, Reachy for robot
# Uses standalone server.py with proper ICE server configuration for remote access
# =============================================================================
[program:pipecat-bot]
command=/bin/bash -c "sleep 25 && cd /app/bot && python server.py --transport webrtc --host 0.0.0.0 --port 7880 -f ."
environment=DISPLAY=":99",PYTHONUNBUFFERED="1"
autostart=true
autorestart=true
priority=60
startsecs=28
stopwaitsecs=10
stdout_logfile=/var/log/supervisor/pipecat-bot.log
stderr_logfile=/var/log/supervisor/pipecat-bot_err.log

# =============================================================================
# Caddy - TLS Reverse Proxy for Pipecat WebRTC
# HTTPS required for browser getUserMedia (microphone/camera)
# =============================================================================
[program:caddy]
command=/bin/bash -c "sleep 28 && /usr/local/bin/caddy run --config /etc/caddy/Caddyfile"
autostart=true
autorestart=true
priority=75
startsecs=30
stdout_logfile=/var/log/supervisor/caddy.log
stderr_logfile=/var/log/supervisor/caddy_err.log

